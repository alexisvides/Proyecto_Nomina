{% extends 'base.html' %}
{% block title %}Dashboard - App N칩mina{% endblock %}

{% block content %}
<section class="section">
  <!-- Encabezado -->
  <div class="card" style="margin-bottom:24px;">
    <h2 class="card-title" style="margin-bottom:8px;">Bienvenido, {{ usuario }} 游녦</h2>
    <p class="card-subtitle">Rol: <strong>{{ rol }}</strong></p>
  </div>

  <!-- Estad칤sticas R치pidas -->
  <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:16px; margin-bottom:24px;">
    <!-- Empleados Activos -->
    <div class="card" style="padding:20px;">
      <div style="display:flex; align-items:center; gap:12px;">
        <div style="background:#1e40af; padding:12px; border-radius:10px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
        </div>
        <div>
          <div style="font-size:28px; font-weight:700; line-height:1;">{{ stats.empleados }}</div>
          <div style="color:var(--muted); font-size:14px;">Empleados Activos</div>
        </div>
      </div>
    </div>

    <!-- Periodos -->
    <div class="card" style="padding:20px;">
      <div style="display:flex; align-items:center; gap:12px;">
        <div style="background:#059669; padding:12px; border-radius:10px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
        </div>
        <div>
          <div style="font-size:28px; font-weight:700; line-height:1;">{{ stats.periodos }}</div>
          <div style="color:var(--muted); font-size:14px;">Periodos de N칩mina</div>
        </div>
      </div>
    </div>

    <!-- Departamentos -->
    <div class="card" style="padding:20px;">
      <div style="display:flex; align-items:center; gap:12px;">
        <div style="background:#7c3aed; padding:12px; border-radius:10px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
        </div>
        <div>
          <div style="font-size:28px; font-weight:700; line-height:1;">{{ stats.departamentos }}</div>
          <div style="color:var(--muted); font-size:14px;">Departamentos</div>
        </div>
      </div>
    </div>

    <!-- D칤as Laborados -->
    <div class="card" style="padding:20px;">
      <div style="display:flex; align-items:center; gap:12px;">
        <div style="background:#ea580c; padding:12px; border-radius:10px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
          </svg>
        </div>
        <div>
          <div style="font-size:28px; font-weight:700; line-height:1;">{{ stats.total_dias_laborados }}</div>
          <div style="color:var(--muted); font-size:14px;">D칤as Laborados Total</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gr치ficas en Grid -->
  <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(450px, 1fr)); gap:20px; margin-bottom:24px;">
    
    <!-- Gr치fica: Empleados Mejor Pagados -->
    <div class="card">
      <h3 class="card-title" style="margin-bottom:16px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle; margin-right:8px;">
          <line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/>
        </svg>
        Top 10 Empleados Mejor Pagados
      </h3>
      <canvas id="chartMejorPagados" style="max-height:300px;"></canvas>
    </div>

    <!-- Gr치fica: Empleados por Departamento -->
    <div class="card">
      <h3 class="card-title" style="margin-bottom:16px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle; margin-right:8px;">
          <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/>
        </svg>
        Distribuci칩n por Departamento
      </h3>
      <canvas id="chartDepartamentos" style="max-height:300px;"></canvas>
    </div>

  </div>

  <!-- Gr치ficas de Tendencias -->
  <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(450px, 1fr)); gap:20px; margin-bottom:24px;">
    
    <!-- Gr치fica: N칩mina 칔ltimos Meses -->
    <div class="card">
      <h3 class="card-title" style="margin-bottom:16px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle; margin-right:8px;">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
        </svg>
        N칩mina 칔ltimos 6 Meses
      </h3>
      <canvas id="chartNomina" style="max-height:300px;"></canvas>
    </div>

    <!-- Gr치fica: Asistencia Semanal -->
    <div class="card">
      <h3 class="card-title" style="margin-bottom:16px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle; margin-right:8px;">
          <path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/>
        </svg>
        Asistencia 칔ltima Semana
      </h3>
      <canvas id="chartAsistencia" style="max-height:300px;"></canvas>
    </div>

  </div>

  <!-- Accesos R치pidos -->
  <div class="card">
    <h3 class="card-title" style="margin-bottom:16px;">Accesos R치pidos</h3>
    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
      {% if 'Periodos' in permisos_usuario %}
      <a href="{{ url_for('periodos_listado') }}" class="btn btn-outline" style="justify-content:flex-start;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px;">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        Periodos de N칩mina
      </a>
      {% endif %}
      {% if 'Empleados' in permisos_usuario %}
      <a href="{{ url_for('empleados_listado') }}" class="btn btn-outline" style="justify-content:flex-start;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px;">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
        Empleados
      </a>
      {% endif %}
      {% if 'Asistencia' in permisos_usuario %}
      <a href="{{ url_for('asistencia_listado') }}" class="btn btn-outline" style="justify-content:flex-start;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px;">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
        </svg>
        Asistencia
      </a>
      {% endif %}
      {% if 'Reportes' in permisos_usuario %}
      <a href="{{ url_for('reportes_listado') }}" class="btn btn-outline" style="justify-content:flex-start;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px;">
          <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
        </svg>
        Reportes
      </a>
      {% endif %}
    </div>
  </div>
</section>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  // Debug: Verificar datos
  console.log('Datos del dashboard:', {
    empleados: {{ empleados_mejor_pagados|tojson }},
    departamentos: {{ empleados_por_departamento|tojson }},
    nomina: {{ nomina_ultimos_meses|tojson }},
    asistencia: {{ asistencia_semanal|tojson }}
  });

  // Configuraci칩n global de Chart.js
  Chart.defaults.color = '#94a3b8';
  Chart.defaults.borderColor = '#1f2a44';
  Chart.defaults.font.family = 'Inter, sans-serif';

  // Gr치fica: Empleados Mejor Pagados (Barras Horizontales)
  const ctxMejorPagados = document.getElementById('chartMejorPagados').getContext('2d');
  
  const empleadosData = {{ empleados_mejor_pagados|tojson }};
  const empleadosLabels = empleadosData.map(e => e[0] || 'Sin nombre');
  const empleadosSalarios = empleadosData.map(e => parseFloat(e[1]) || 0);
  
  new Chart(ctxMejorPagados, {
    type: 'bar',
    data: {
      labels: empleadosLabels,
      datasets: [{
        label: 'Salario Base (Q)',
        data: empleadosSalarios,
        backgroundColor: 'rgba(30, 64, 175, 0.8)',
        borderColor: 'rgba(30, 64, 175, 1)',
        borderWidth: 1
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (context) => 'Q ' + context.parsed.x.toLocaleString('es-GT', {minimumFractionDigits: 2})
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: {
            callback: (value) => 'Q ' + value.toLocaleString('es-GT')
          }
        }
      }
    }
  });

  // Gr치fica: Empleados por Departamento (Dona)
  const ctxDepartamentos = document.getElementById('chartDepartamentos').getContext('2d');
  
  const deptosData = {{ empleados_por_departamento|tojson }};
  const deptosLabels = deptosData.map(d => d[0]);
  const deptosCantidad = deptosData.map(d => d[1]);
  
  new Chart(ctxDepartamentos, {
    type: 'doughnut',
    data: {
      labels: deptosLabels,
      datasets: [{
        data: deptosCantidad,
        backgroundColor: [
          'rgba(30, 64, 175, 0.8)',
          'rgba(5, 150, 105, 0.8)',
          'rgba(124, 58, 237, 0.8)',
          'rgba(220, 38, 38, 0.8)',
          'rgba(234, 88, 12, 0.8)',
          'rgba(14, 165, 233, 0.8)'
        ],
        borderColor: [
          'rgba(30, 64, 175, 1)',
          'rgba(5, 150, 105, 1)',
          'rgba(124, 58, 237, 1)',
          'rgba(220, 38, 38, 1)',
          'rgba(234, 88, 12, 1)',
          'rgba(14, 165, 233, 1)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: { padding: 15, font: { size: 12 } }
        }
      }
    }
  });

  // Gr치fica: N칩mina 칔ltimos Meses (L칤nea)
  const ctxNomina = document.getElementById('chartNomina').getContext('2d');
  
  const nominaData = {{ nomina_ultimos_meses|tojson }};
  const nominaLabels = nominaData.map(n => n[0]);
  const nominaTotales = nominaData.map(n => n[1] || 0);
  
  new Chart(ctxNomina, {
    type: 'line',
    data: {
      labels: nominaLabels,
      datasets: [{
        label: 'Total Pagado (Q)',
        data: nominaTotales,
        fill: true,
        backgroundColor: 'rgba(5, 150, 105, 0.2)',
        borderColor: 'rgba(5, 150, 105, 1)',
        borderWidth: 2,
        tension: 0.4,
        pointBackgroundColor: 'rgba(5, 150, 105, 1)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (context) => 'Q ' + (context.parsed.y || 0).toLocaleString('es-GT', {minimumFractionDigits: 2})
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: (value) => 'Q ' + value.toLocaleString('es-GT')
          }
        }
      }
    }
  });

  // Gr치fica: Asistencia Semanal (Barras)
  const ctxAsistencia = document.getElementById('chartAsistencia').getContext('2d');
  
  const asistenciaData = {{ asistencia_semanal|tojson }};
  const asistenciaLabels = asistenciaData.map(a => a[0]);
  const asistenciaCantidad = asistenciaData.map(a => a[1]);
  
  new Chart(ctxAsistencia, {
    type: 'bar',
    data: {
      labels: asistenciaLabels,
      datasets: [{
        label: 'Empleados Presentes',
        data: asistenciaCantidad,
        backgroundColor: 'rgba(124, 58, 237, 0.8)',
        borderColor: 'rgba(124, 58, 237, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      }
    }
  });
</script>
{% endblock %}

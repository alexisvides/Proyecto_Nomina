{% extends 'base.html' %}
{% block title %}Gestión de Permisos{% endblock %}

{% block content %}
<section class="section">
  <div class="card">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;">
      <h2 class="card-title" style="margin:0;">Gestión de Permisos por Usuario</h2>
    </div>
    <p class="card-subtitle">Configura qué módulos puede acceder cada usuario mediante checkboxes.</p>

    {% if usuarios %}
    <div style="margin-top:24px;">
      <form method="post" action="{{ url_for('permisos_guardar') }}">
        <div style="overflow:auto;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="text-align:left; border-bottom:2px solid #1f2a44; color:var(--muted);">
                <th style="padding:12px 8px; position:sticky; left:0; background:#0a1120; z-index:10;">Usuario</th>
                <th style="padding:12px 8px; position:sticky; left:0; background:#0a1120; z-index:10; padding-left:180px;">Rol</th>
                {% for mod in modulos %}
                <th style="padding:12px 8px; text-align:center; min-width:100px;">
                  <div style="display:flex; flex-direction:column; align-items:center; gap:4px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      {% if mod[4] == 'home' %}
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                      {% elif mod[4] == 'calendar' %}
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                      {% elif mod[4] == 'users' %}
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                      {% elif mod[4] == 'building' %}
                        <rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/>
                      {% elif mod[4] == 'gift' %}
                        <polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/>
                      {% elif mod[4] == 'clock' %}
                        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                      {% elif mod[4] == 'user-check' %}
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/>
                      {% elif mod[4] == 'shield' %}
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                      {% elif mod[4] == 'file-text' %}
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                      {% elif mod[4] == 'bar-chart' %}
                        <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
                      {% elif mod[4] == 'file-down' %}
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="m9 15 3 3 3-3"/>
                      {% endif %}
                    </svg>
                    <span style="font-size:11px; font-weight:600;">{{ mod[1] }}</span>
                  </div>
                </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for usuario in usuarios %}
              <tr style="border-bottom:1px solid #1f2a44;">
                <td style="padding:12px 8px; position:sticky; left:0; background:#0a1120; font-weight:600;">
                  {{ usuario[1] }}
                </td>
                <td style="padding:12px 8px; position:sticky; left:180px; background:#0a1120;">
                  <span style="display:inline-block; padding:4px 10px; background:#1e40af; border-radius:6px; font-size:12px; font-weight:500;">
                    {{ usuario[2] if usuario[2] else 'Sin rol' }}
                  </span>
                </td>
                {% for mod in modulos %}
                <td style="padding:12px 8px; text-align:center;">
                  <input 
                    type="checkbox" 
                    name="permiso_{{ usuario[0] }}_{{ mod[0] }}" 
                    value="1"
                    {% if usuario[0]|string in permisos and mod[0] in permisos[usuario[0]|string] %}checked{% endif %}
                    style="width:18px; height:18px; cursor:pointer;"
                  />
                </td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div style="margin-top:24px; display:flex; gap:12px;">
          <button type="submit" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            Guardar Permisos
          </button>
          <a href="{{ url_for('usuarios_listado') }}" class="btn btn-outline">Cancelar</a>
        </div>
      </form>
    </div>
    {% else %}
    <p style="margin-top:16px; color:var(--muted);">No hay usuarios registrados.</p>
    {% endif %}
  </div>
</section>

<style>
  /* Hacer la tabla scrolleable horizontalmente */
  table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }
  thead, tbody {
    display: table;
    width: 100%;
    table-layout: fixed;
  }
  thead tr, tbody tr {
    display: table-row;
  }
  th, td {
    display: table-cell;
  }
</style>
{% endblock %}
